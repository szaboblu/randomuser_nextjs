import Head from "next/head";
import styles from "../styles/Home.module.css";
import axios from "axios";
import { useQuery } from "react-query";

export default function Home() {
  //get users from randomuser.me using axios and react-query
  const { isLoading, error, data } = useQuery(["fetchUsers"], () =>
    axios
      .get("https://randomuser.me/api/?results=500")
      .then((res) =>
        res.data.results.filter((user: any) =>
          hasPrimes(user.location.postcode, 2)
        )
      )
  );

  // check number is prime
  const isPrime = (num: number) => {
    for (let i = 2, s = Math.sqrt(num); i <= s; i++)
      if (num % i === 0) return false;
    return num > 1;
  };

  // check string contains at least X prime numbers
  const hasPrimes = (postcode: string | number, cap: number) => {
    const postcodeString = postcode.toString();
    const numberString = postcodeString.match(/\d+/g)?.join("");
    let count = 0;
    if (numberString) {
      numberString.split("").forEach((number: string) => {
        if (isPrime(parseInt(number))) {
          count++;
        }
      });
    }
    return count >= cap;
  };

  return (
    <div className={styles.container}>
      <Head>
        <title>Random User Generator</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className={styles.main}>
        <h1 className={styles.title}>Random user generator</h1>
      </main>
    </div>
  );
}
